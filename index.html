<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
 
    <title>Audio Visulizer</title>
	<link rel="stylesheet" href="./app.css"/>
</head>

<body onload='init()'>
	<div id="main-content-container" >		
		<button onclick="start()">start</button>
		<button onclick="stop()">stop</button>
		<div id="info"></div>
		<div id="visualizer_wrapper">
			<canvas id='canvas' width="800" height="350"></canvas>
		</div>
    </div>
    <script>		
		const url = 'ws://109.123.120.200:5000';
		let ws, player;	

        const init = () => {
			console.log(`[${new Date()}] AudioCapture App Start...`);
			ws = new WebSocket(url);

			// 接收二进制数据，需要配置binaryType
			ws.binaryType = 'arraybuffer';
			player = new StreamVisulizer();
			// 绑定链接open & close 事件
			ws.addEventListener('open', event => (console.log(`[${new Date()}] ws server open sucess!`)));
			ws.addEventListener('close', event => (console.log(`[${new Date()}] ws server closed!`)));

			ws.addEventListener('message', event => {
				let raw = new Uint8Array(event.data);				
				player.feed(raw);
			});

        }
		
		const start = () => {
			ws.send('start');
			setTimeout(() => {
				const {channels, sampleRate} = player.getAudioInfo();
				document.getElementById('info').innerHTML = `<div>Num of Channels: ${channels}</div>
															<div>Sample Rate: ${sampleRate}</div>`
			}, 1000);
		}
		
		const stop = () => {
			player.stop();
		}

		setInterval(() => {
			let analyser = player.getAnalyzser();
			var array = new Uint8Array(analyser.frequencyBinCount);
			analyser.getByteFrequencyData(array);
			
			//console.log(array);
		}, 1000);

	</script>
	<script type="text/javascript" src="./dist/index.js"></script>
</body>
</html>